<% layout("/layouts/boilerplate") -%>

  <div class="row mt-4">
    <div class="col-lg-10 mx-auto">

      <!-- Title -->
      <h2 class="fw-bold mb-2">
        <%= listing.title %>
      </h2>

      <!-- Location + Category -->
      <div class="d-flex align-items-center gap-3 mb-3 flex-wrap">
        <span class="badge bg-light text-dark border">
          &#x1F4CD; <%= listing.location %>, <%= listing.country %>
        </span>

        <span class="badge bg-teal-subtle text-dark border" style="background-color: #ccfbf1; color: #0f766e;">
          <%= listing.category %>
        </span>
      </div>

      <!-- Image -->
      <div class="card show-card listing-card mb-4">
        <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="listing_image">
      </div>

      <!-- Info Grid -->
      <div class="row">

        <!-- Left: Description -->
        <div class="col-lg-8">

          <div class="mb-4">
            <h5 class="fw-semibold">Hosted by <%= (listing.owner && listing.owner.username) ? listing.owner.username
                : 'RAJSPACE Host' %>
                <span class="badge rounded-pill text-bg-success ms-2">RAJSPACE Verified Host</span>
            </h5>
            <p class="text-muted mb-2">
              <%= (listing.owner && listing.owner.username) ? 'Verified host on RAJSPACE' : 'RAJSPACE' %>
            </p>
          </div>

          <div class="mb-4">
            <h5 class="fw-semibold">About this place</h5>
            <p class="fs-6">
              <%= listing.description %>
            </p>
            <% if(currUser && listing.owner && currUser._id.equals(listing.owner._id)) { %>
              <div class="card p-2 border-0 bg-light mt-3">
                <div class="d-flex gap-2">
                  <a href="/listings/<%= listing._id %>/edit" class="btn btn-outline-success w-50">
                    <i class="fa-solid fa-pen"></i> Edit
                  </a>
                  <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="w-50">
                    <button type="submit" class="btn btn-outline-danger w-100">
                      <i class="fa-solid fa-trash"></i> Delete
                    </button>
                  </form>
                </div>
              </div>
              <% } %>
          </div>

        </div>

        <!-- Right: Price Card -->
        <div class="col-lg-4">

          <div class="card p-3 shadow-sm price-card">
            <h4 class="fw-bold mb-3">
              &#8377; <%= listing.price.toLocaleString("en-IN") %>
                <span class="fs-6 fw-normal text-muted">/ night</span>
            </h4>

            <a href="/listings/<%= listing._id %>/reserve" class="btn btn-danger w-100 mb-2 text-decoration-none">
              Reserve
            </a>
            <form action="/wishlist/<%= listing._id %>" method="POST" class="mb-2">
              <button type="submit" class="btn btn-outline-secondary w-100">
                <i class="fa-regular fa-heart"></i> Save to wishlist
              </button>
            </form>

            <p class="text-muted small text-center">
              You won&rsquo;t be charged yet
            </p>
          </div>

        </div>
      </div>

    </div>
  </div>


  <br />









  <div class="col-lg-10 mx-auto mt-5">

    <!-- Review analytics -->
    <% if (typeof reviewStats !=='undefined' && reviewStats.count> 0) { %>
      <div class="card p-3 shadow-sm mb-3 border-0 review-analytics-card">
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <span class="fw-bold fs-5">&#11088; <%= reviewStats.average %></span>
          <span class="text-muted">&middot;</span>
          <span>
            <%= reviewStats.count %>
              <%= reviewStats.count===1 ? 'review' : 'reviews' %>
          </span>
        </div>
      </div>
      <% } %>

        <!-- Reviews List -->
        <div class="card p-4 shadow-sm mb-4">
          <h4 class="fw-bold mb-3">&#11088; Guest Reviews</h4>

          <% if(listing.reviews.length===0) { %>
            <p class="text-muted">No reviews yet. Be the first to leave one!</p>
            <% } %>

              <div class="row">
                <% for(review of listing.reviews) { %>
                  <div class="col-md-6 mb-3">
                    <div class="card h-100 p-3 review-card">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-semibold mb-0">@<%= (review.author && review.author.username) ?
                            review.author.username : 'Anonymous' %>
                        </h6>

                        <% if(currUser && review.author && currUser._id.equals(review.author._id)) { %>
                          <form method="POST"
                            action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                            <button class="btn btn-sm btn-outline-danger">Delete</button>
                          </form>
                          <% } %>
                      </div>

                      <p class="starability-result mb-2" data-rating="<%= review.rating %>"></p>
                      <p class="text-muted mb-0">
                        <%= review.comment %>
                      </p>
                    </div>
                  </div>
                  <% } %>
              </div>
        </div>

        <!-- Review Form -->
        <% if(currUser) { %>
          <div class="card p-4 shadow-sm mb-5">
            <h5 class="fw-bold mb-3">Leave a review</h5>

            <form action="/listings/<%= listing.id %>/reviews" method="POST" novalidate class="needs-validation">

              <div class="mb-3">
                <label class="form-label fw-semibold">Rating</label>
                <fieldset class="starability-slot">

                  <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked />
                  <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                  <label for="first-rate1" title="Terrible">1 star</label>

                  <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                  <label for="first-rate2" title="Not good">2 stars</label>

                  <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                  <label for="first-rate3" title="Average">3 stars</label>

                  <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                  <label for="first-rate4" title="Very good">4 stars</label>

                  <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                  <label for="first-rate5" title="Amazing">5 stars</label>

                </fieldset>
              </div>

              <div class="mb-3">
                <label for="comment" class="form-label fw-semibold">Comments</label>
                <textarea name="review[comment]" id="comment" rows="4" class="form-control"
                  placeholder="Share your experience..." required></textarea>
                <div class="invalid-feedback">Please add some comments for review</div>
              </div>

              <button class="btn btn-danger">Submit Review</button>
            </form>
          </div>
          <% } %>

  </div>

  <div class="col-12 mx-auto mb-3" data-map-token="<%= process.env.MAP_TOKEN %>"
    data-listing='<%- JSON.stringify(listing).replace(/</g, "\\u003c") %>'>
    <h4 class="fw-bold mb-3">&#x1F4CD; Where you'll be</h4>
    <div id="map"></div>
  </div>
  <script src="/js/map.js"></script>